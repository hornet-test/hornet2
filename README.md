# hornet2 (仮称)

[![Rust CI](https://github.com/hornet-test/hornet2/actions/workflows/rust.yml/badge.svg)](https://github.com/hornet-test/hornet2/actions/workflows/rust.yml)
[![JS CI](https://github.com/hornet-test/hornet2/actions/workflows/js.yml/badge.svg)](https://github.com/hornet-test/hornet2/actions/workflows/js.yml)
[![codecov](https://codecov.io/gh/hornet-test/hornet2/graph/badge.svg?token=ZQGM9L3JNE)](https://codecov.io/gh/hornet-test/hornet2)
[![DeepWiki](https://img.shields.io/badge/DeepWiki-hornet--test%2Fhornet2-blue.svg?logo=data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAyCAYAAAAnWDnqAAAAAXNSR0IArs4c6QAAA05JREFUaEPtmUtyEzEQhtWTQyQLHNak2AB7ZnyXZMEjXMGeK/AIi+QuHrMnbChYY7MIh8g01fJoopFb0uhhEqqcbWTp06/uv1saEDv4O3n3dV60RfP947Mm9/SQc0ICFQgzfc4CYZoTPAswgSJCCUJUnAAoRHOAUOcATwbmVLWdGoH//PB8mnKqScAhsD0kYP3j/Yt5LPQe2KvcXmGvRHcDnpxfL2zOYJ1mFwrryWTz0advv1Ut4CJgf5uhDuDj5eUcAUoahrdY/56ebRWeraTjMt/00Sh3UDtjgHtQNHwcRGOC98BJEAEymycmYcWwOprTgcB6VZ5JK5TAJ+fXGLBm3FDAmn6oPPjR4rKCAoJCal2eAiQp2x0vxTPB3ALO2CRkwmDy5WohzBDwSEFKRwPbknEggCPB/imwrycgxX2NzoMCHhPkDwqYMr9tRcP5qNrMZHkVnOjRMWwLCcr8ohBVb1OMjxLwGCvjTikrsBOiA6fNyCrm8V1rP93iVPpwaE+gO0SsWmPiXB+jikdf6SizrT5qKasx5j8ABbHpFTx+vFXp9EnYQmLx02h1QTTrl6eDqxLnGjporxl3NL3agEvXdT0WmEost648sQOYAeJS9Q7bfUVoMGnjo4AZdUMQku50McDcMWcBPvr0SzbTAFDfvJqwLzgxwATnCgnp4wDl6Aa+Ax283gghmj+vj7feE2KBBRMW3FzOpLOADl0Isb5587h/U4gGvkt5v60Z1VLG8BhYjbzRwyQZemwAd6cCR5/XFWLYZRIMpX39AR0tjaGGiGzLVyhse5C9RKC6ai42ppWPKiBagOvaYk8lO7DajerabOZP46Lby5wKjw1HCRx7p9sVMOWGzb/vA1hwiWc6jm3MvQDTogQkiqIhJV0nBQBTU+3okKCFDy9WwferkHjtxib7t3xIUQtHxnIwtx4mpg26/HfwVNVDb4oI9RHmx5WGelRVlrtiw43zboCLaxv46AZeB3IlTkwouebTr1y2NjSpHz68WNFjHvupy3q8TFn3Hos2IAk4Ju5dCo8B3wP7VPr/FGaKiG+T+v+TQqIrOqMTL1VdWV1DdmcbO8KXBz6esmYWYKPwDL5b5FA1a0hwapHiom0r/cKaoqr+27/XcrS5UwSMbQAAAABJRU5ErkJggg==)](https://deepwiki.com/hornet-test/hornet2)
<!-- DeepWiki badge generated by https://deepwiki.ryoppippi.com/ -->

**ドキュメント駆動型 API テストツール**

[Arazzo Specification](https://spec.openapis.org/arazzo/) と OpenAPI を活用し、
**API ドキュメントを充実させるだけで自動テストが実現できる**新しい開発体験を提供します。

## 🎯 コンセプト

- **OpenAPI/Arazzo を書く = テストを書く**
  `example` や `x-examples` を充実させ、Arazzo でワークフローを定義するだけで、自動テストが動く世界を目指します。

- **グラフィカルな可視化**
  API コールフローをビジュアルで把握。開発者にもQAエンジニアにも、システムの挙動が一目でわかります。

- **AI 時代の API テスト基盤**
  標準化された YAML 形式により、LLM がテストシナリオを理解・生成しやすくなります。

- **シングルバイナリ + Web UI**
  Rust 製の軽量バイナリ一つで完結。サーバーモードで起動すれば、モダンな SPA として UI が利用できます。

## ✨ 特徴

### 1. 標準仕様準拠

- **OpenAPI 3.x** と **Arazzo Specification** をベースに、再利用可能な API テストを構築
- 既存の OpenAPI 定義を活かし、追加の学習コストを最小化

### 2. 段階的な実装戦略

- **Phase 1**: Arazzo/OpenAPI の可視化（フロー図生成）
- **Phase 2**: 外部ツール（k6 など）への変換・実行
- **Phase 3**: Rust 製の高速実行エンジンの内製化

### 3. 豊富なレポート機能

- CLI / JSON / HTML 出力
- インタラクティブな Web UI でのフロー可視化
- レスポンスタイム分析・エラー率の可視化

### 4. CI/CD & ローカル開発の両対応

- **QA/SETエンジニア**: CI パイプラインでの自動テスト実行
- **バックエンド開発者**: ローカルでの動作確認・デバッグ

## 📊 競合ツールとの比較

| ツール | 特徴 | hornet2 の違い |
|--------|------|---------------|
| **Postman/Newman** | GUI 中心、コレクション管理 | YAML 駆動、標準仕様準拠 |
| **k6** | JavaScript 記述、高性能負荷試験 | 宣言的、可視化重視、標準仕様準拠 |
| **JMeter** | 多機能だが重い GUI | 軽量シングルバイナリ、モダンな UX |
| **Dredd/Schemathesis** | OpenAPI テストのみ | Arazzo ワークフロー対応、フロー可視化 |

**差別化ポイント**:
- Arazzo による**ワークフロー定義の標準化**
- **ドキュメント = テスト**という体験設計
- **AI との連携**を見据えた構造化データ
- 最終的には **Rust 製高速エンジン**による省メモリ・高速実行

## 🚀 クイックスタート

### インストール

```bash
git clone <repository-url>
cd hornet2

# mise を使う場合（推奨）
mise install
make install

# または cargo のみ
cargo build --release
```

### 使い方

#### 1. ワークフロー一覧の表示

```bash
# Makefile を使う場合
make validate

# または直接 cargo で実行
cargo run -- validate --openapi tests/fixtures/openapi.yaml --arazzo tests/fixtures/arazzo.yaml
# Arazzo ファイル内のワークフローを一覧表示
cargo run -- list --arazzo tests/fixtures/arazzo.yaml
```

#### 2. OpenAPI/Arazzo の検証

```bash
# OpenAPI と Arazzo 仕様の検証
cargo run -- validate --openapi tests/fixtures/openapi.yaml --arazzo tests/fixtures/arazzo.yaml
```

#### 3. フロー図の生成 (CLI)

```bash
# Makefile を使う場合
make visualize ARGS="--format dot"
make visualize ARGS="--format json"

# または直接 cargo で実行
cargo run -- visualize --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --format dot
# DOT 形式で出力
cargo run -- visualize --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --format dot

# JSON 形式で出力
cargo run -- visualize --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --format json
```

#### 4. Web UI での可視化とエディタ ✨

**開発モード（推奨）**:
```bash
make dev
# APIサーバー: http://localhost:3000
# UI開発サーバー: http://localhost:5173 ← ブラウザでこちらを開く
```

**2つのタブが利用可能**:
- **Visualization**: ワークフローのグラフ可視化（既存機能）
- **Editor**: Arazzo ワークフローの作成・編集（新機能！）

# または、CLIサーバーのみ起動
cargo run -- serve --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --port 3000

**本番モード**:
```bash
# UIをビルドしてから起動
make build
make cli-dev
# → http://localhost:3000
```

**その他の起動方法**:
```bash
# CLI サーバーのみ起動（本番ビルド版UIを配信）
make cli-dev

# または直接 cargo で実行
cargo run -- serve --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --port 3000
```

**Web UI 機能**:

*Visualization タブ*:
- インタラクティブなグラフ可視化（Cytoscape.js）
- ノードのクリックで詳細表示
- 複数レイアウト対応（階層型、円形、グリッドなど）
- HTTPメソッドによる色分け
- ズーム・パン操作

*Editor タブ（新機能）*:
- OpenAPI Operation一覧の表示とフィルタリング
- ビジュアルワークフロービュー
- YAML エディタ（Monaco Editor）
- リアルタイムバリデーション
- Visual ↔ YAML の双方向同期

詳細は [EDITOR_GUIDE.md](EDITOR_GUIDE.md) を参照してください。

#### 5. k6 スクリプトへの変換 ✨

```bash
# k6 スクリプトを生成（標準出力）
cargo run -- convert --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --to k6

# ファイルに出力
cargo run -- convert --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --to k6 --output test.js

# 特定のワークフローのみ変換
cargo run -- convert --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --to k6 --workflow user-onboarding-flow

# 負荷試験オプション付き
cargo run -- convert --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --to k6 --vus 10 --duration 30s
```

#### 6. テスト実行 ✨

```bash
# k6 を使ってテストを実行（k6 のインストールが必要）
cargo run -- run --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --engine k6

# 負荷試験オプション付き
cargo run -- run --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml --engine k6 --vus 10 --duration 30s
```

**実行結果の例**:
```
→ Generating test script...
✓ k6 version: k6 v0.48.0
→ Running tests with k6...

✓ Test run completed successfully!

Metrics Summary:
  HTTP Requests: 4
  Iterations: 1
  Avg Response Time: 123.45ms
  Checks: 8 passed, 0 failed
```

## 🛠️ 開発環境のセットアップ

### 必要なツール

このプロジェクトでは [mise](https://mise.jdx.dev/) を使用してツールバージョンを管理しています。

- Rust (stable)
- Node.js 22
- pnpm 10

### セットアップ手順

#### 1. mise のインストール

```bash
# macOS/Linux
curl https://mise.run | sh

# または Homebrew
brew install mise
```

#### 2. 必要なツールのインストール

```bash
# プロジェクトルートで実行
mise install
```

これにより、[mise.toml](mise.toml) で定義された Rust、Node.js、pnpm が自動的にインストールされます。

#### 3. Rust プロジェクトのビルド

```bash
cargo build
```

#### 4. UI 開発のセットアップ

```bash
cd ui
pnpm install
```

### UI 開発

React + Vite で構築された Web UI を開発する場合：

```bash
cd ui

# 開発サーバーを起動 (http://localhost:5173)
pnpm dev

# プロダクションビルド
pnpm build

# テスト実行
pnpm test
```

**UI の技術スタック**:
- React 18
- Vite (ビルドツール)
- Vitest (テスト)
- Cytoscape.js (グラフ可視化)

**開発時のワークフロー**:
1. `pnpm dev` で開発サーバーを起動
2. UI コードを編集（[ui/src/](ui/src/) 配下）
3. ブラウザで自動リロード
4. `pnpm test` でテスト実行

### フルスタック開発

UI と Rust サーバーを同時に開発する場合、**`make dev` を使うのが最も簡単です**：

```bash
make dev
```

これにより：
- 🦀 **APIサーバー**が http://localhost:3000 で起動
- ⚛️ **UI開発サーバー**が http://localhost:5173 で起動
- 🔗 **自動プロキシ**: UI開発サーバーから `/api/*` へのリクエストがAPIサーバー（3000）に自動転送される
- 🔄 **ホットリロード**: UIコードの変更が即座に反映される

**ブラウザで http://localhost:5173 を開く**と、Viteの開発サーバーでホストされたページからAPIサーバーを参照できます。

#### 手動での起動（2つのターミナル）

または、個別に起動することもできます：

```bash
# ターミナル1: Rust APIサーバー起動
cargo run -- serve --arazzo tests/fixtures/arazzo.yaml --openapi tests/fixtures/openapi.yaml

# ターミナル2: UI 開発サーバー起動
cd ui && pnpm dev
```

**注意**: Viteの開発サーバー（5173）は [vite.config.js](ui/vite.config.js) でプロキシ設定されており、`/api/*` へのリクエストを自動的にポート3000に転送します。

### Makefile を使った開発

より便利な開発のために [Makefile](Makefile) を用意しています：

```bash
# ヘルプを表示
make help

# 依存関係をすべてインストール
make install

# 開発モード: CLIとUIを同時起動（Ctrl+Cで両方停止）
make dev

# ビルド
make build              # CLIとUIを両方ビルド
make cli-build          # CLIのみビルド
make ui-build           # UIのみビルド

# テスト
make test               # すべてのテストを実行
make cli-test           # Rustのテストのみ
make ui-test            # UIのテストのみ
make ui-test-watch      # UIテストをwatchモード

# その他の便利なコマンド
make visualize          # フロー図を生成
make validate           # OpenAPI/Arazzoを検証
make check              # コードチェック（fmt + clippy）
make fmt                # コードフォーマット
make clean              # ビルド成果物をクリーンアップ
```

**推奨ワークフロー**:
1. `make install` で初回セットアップ
2. `make dev` で開発サーバーを起動（CLI: http://localhost:3000、UI: http://localhost:5173）
3. コードを編集して自動リロード
4. `make test` でテストを実行
5. `make build` で本番ビルド

## 🔧 ロードマップ

### Phase 1: 可視化 + エディタ (MVP)
- [x] OpenAPI / Arazzo YAML パーサー ✅
- [x] フロー図の生成（グラフ構造への変換） ✅
- [x] Web UI での可視化 ✅
- [x] CLI での基本操作 ✅
- [x] Web エディタ（Phase 1 MVP） ✅
  - [x] Operation リスト表示・検索・フィルタ
  - [x] ビジュアルワークフロービュー
  - [x] YAML エディタと双方向同期
  - [x] リアルタイムバリデーション

### Phase 2: テスト実行
- [x] 外部ツール（k6）への DSL 変換 ✅
- [x] テスト実行の自動化 ✅
- [x] 結果レポートの生成（k6 メトリクス解析） ✅

### Phase 3: 高速エンジン化
- [ ] Rust 製 HTTP クライアントの実装
- [ ] 負荷試験機能（RPS/VU/Ramp-up）
- [ ] 並列実行・非同期最適化

### 将来的な拡張
- SaaS 版（結果の保存・共有、分散負荷試験）
- カスタムフック・プラグイン機構
- Prometheus / OTLP エクスポート

## 🧪 想定ユースケース

### ✅ 典型的なシナリオ
- **ユーザー登録 → ログイン → プロフィール更新**の一連フローテスト
- **OpenAPI の example から Arazzo を自動生成**してスモークテスト実行
- **マイクロサービス間の依存関係**をフロー図で可視化・検証
- **CI/CD パイプライン**での自動 API テスト

### 🎯 開発フロー
1. OpenAPI に `example` / `x-examples` を記述
2. Arazzo でワークフロー（ステップ間のデータ受け渡し）を定義
3. `hornet2 visualize` でフローを確認
4. `hornet2 run` でテスト実行
5. HTML レポートで結果確認
