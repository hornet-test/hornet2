# ローカルArazzoファイルCRUD APIの設計

## 概要
このドキュメントは、ローカルのArazzo仕様ファイルを変更できるように、Hornet2 APIサーバーにCRUD（作成、読み取り、更新、削除）機能を追加するための設計概要です。

## 目標
- フロントエンドが完全なArazzo仕様を取得できるようにする。
- フロントエンドがArazzo仕様を変更（ワークフローの更新、追加、削除）できるようにする。
- 変更をローカルファイルシステムに永続化する。

## 提案するAPIエンドポイント

### 1. 完全な仕様の取得
- **エンドポイント**: `GET /api/spec`
- **説明**: 完全なArazzo仕様構造を返します。
- **レスポンス**: `ArazzoSpec`を含むJSONボディを持つ `200 OK`。

### 2. 完全な仕様の更新
- **エンドポイント**: `PUT /api/spec`
- **説明**: 提供されたJSONでArazzo仕様全体を置き換えます。
- **ボディ**: `ArazzoSpec`のJSON表現。
- **動作**:
    1. 受信した仕様を検証します。
    2. YAMLにシリアライズします。
    3. `arazzo_path`にあるファイルを上書きします。
- **レスポンス**: 成功した場合は `200 OK`、検証に失敗した場合は `400 Bad Request`。

### 3. ワークフローの取得
- **エンドポイント**: `GET /api/workflows/:workflow_id`
- **説明**: IDで指定された単一のワークフローを返します。
- **レスポンス**: `Workflow`オブジェクトを持つ `200 OK`、または `404 Not Found`。

### 4. ワークフローの作成/更新
- **エンドポイント**: `PUT /api/workflows/:workflow_id`
- **説明**: 指定されたIDでワークフローを作成または更新します。
- **ボディ**: `Workflow`のJSON表現。
- **動作**:
    1. 現在のArazzo仕様をロードします。
    2. `workflow_id`を持つワークフローが存在するか確認します。
    3. 存在する場合は更新します。存在しない場合はリストに追加します。
    4. 更新された仕様を検証します。
    5. ファイルに保存します。
- **レスポンス**: 更新されたワークフローを持つ `200 OK`。

### 5. ワークフローの削除
- **エンドポイント**: `DELETE /api/workflows/:workflow_id`
- **説明**: IDで指定されたワークフローを削除します。
- **動作**:
    1. 現在のArazzo仕様をロードします。
    2. `workflow_id`を持つワークフローを削除します。
    3. ファイルに保存します。
- **レスポンス**: `200 OK`、存在しなかった場合は `404 Not Found`。

## 実装の詳細

### データの永続化
- サーバーは現在、リクエストごとにArazzoファイルを読み込んでいます。
- 書き込み操作のために、読み込み、変更、そして `fs::write` を使用して同じパスに書き戻します。
- ファイル形式を維持するために `serde_yaml` を使用してシリアライズする必要があります。

### 検証
- `ArazzoSpec`、`Workflow` などにある既存の `validate()` メソッドを再利用します。
- 一部を変更しても参照が壊れないことを確認します（ただし、深い参照整合性チェックはMVPの範囲外とし、基本的なIDの一意性チェックは既存のものを使用します）。

### エラーハンドリング
- 適切なHTTPステータスコードを返します（検証エラーの場合は400、見つからない場合は404、IOエラーの場合は500）。
- 説明的なエラーメッセージを返します。

## セキュリティに関する考慮事項
- このAPIはサーバー上のファイルを変更することを許可します。これはローカル開発ツール（「ローカルArazzoファイル」という前提）であるため、ユーザーはファイルシステムへのアクセス権を持っていると想定されます。
- パスは起動時に固定されるため、基本的なパストラバーサルチェックはここでは無関係です。

## 計画
1. `loader` モジュールに `save_arazzo` ヘルパー関数を実装します。
2. `GET /api/spec` エンドポイントを実装します。
3. `PUT /api/spec` エンドポイントを実装します。
4. `/api/workflows/:workflow_id` の `GET`、`PUT`、`DELETE` を実装します。
5. `server/mod.rs` に新しいルートを登録します。
6. 新しいエンドポイントのテストを追加します。
